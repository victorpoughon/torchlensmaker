```python
import torch
import torch.nn as nn
import torch.optim as optim
import torchlensmaker as tlm

surface = tlm.surfaces.Sphere(diameter=15, r=tlm.parameter(18))
lens = tlm.BiLens(surface, material="SF10-nd", outer_thickness=1.5)

optics = nn.Sequential(
    tlm.Offset(
        tlm.Rotate(
            tlm.RaySource(),
            [-55, 0]),
        y=17.9),
    tlm.Gap(10),
    lens,
    tlm.Gap(30),
    tlm.FocalPoint(),
)

lens.surface2.element[1].critical_angle = "clamp"

tlm.show(optics, dim=2, end=10, sampling={"base": 10})
```


<div data-jp-suppress-context-menu id='tlmviewer-929e921d' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 10.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[1.63693237, 7.50000191], [1.60452843, 7.42889786], [1.57243156, 7.35764885], [1.5406456, 7.28626585], [1.50917053, 7.21474552], [1.47800636, 7.14308882], [1.44715309, 7.07129765], [1.41661072, 6.99936914], [1.38638115, 6.92731285], [1.35646439, 6.8551259], [1.32686234, 6.78281021], [1.297575, 6.71036625], [1.26860237, 6.6377964], [1.23994446, 6.56510019], [1.21160126, 6.49227715], [1.18357468, 6.41933584], [1.15586662, 6.34627342], [1.12847519, 6.27309132], [1.10140228, 6.19979095], [1.074646, 6.12636995], [1.04821014, 6.05283737], [1.02209473, 5.97919035], [0.99629784, 5.90543127], [0.97082138, 5.83156061], [0.94566727, 5.75758076], [0.92083359, 5.68349171], [0.89632034, 5.60929108], [0.87213135, 5.53498936], [0.84826469, 5.46058321], [0.82472229, 5.38607407], [0.80150032, 5.31146336], [0.77860451, 5.2367487], [0.75603294, 5.16193914], [0.73378754, 5.08703232], [0.71186638, 5.01203012], [0.69027138, 4.93693352], [0.66900253, 4.86174297], [0.64806175, 4.78646135], [0.62744522, 4.71108532], [0.60715675, 4.63562536], [0.58719635, 4.56007719], [0.56756592, 4.48444319], [0.54826355, 4.40872478], [0.52928734, 4.33291912], [0.51064301, 4.25703621], [0.49232674, 4.18107271], [0.47434044, 4.10503054], [0.45668602, 4.02891111], [0.43936157, 3.95271564], [0.4223671, 3.87644148], [0.40570259, 3.80009842], [0.38937378, 3.7236836], [0.37337494, 3.64719892], [0.35770607, 3.57064533], [0.34237289, 3.49402475], [0.32736969, 3.41733384], [0.31270218, 3.34058261], [0.29836655, 3.26376867], [0.28436661, 3.18689322], [0.27069664, 3.10995746], [0.25736427, 3.03296328], [0.24436378, 2.95590782], [0.2317009, 2.87880063], [0.21936989, 2.80163956], [0.20737457, 2.72442532], [0.19571495, 2.64716005], [0.18439293, 2.56984448], [0.17340279, 2.49247646], [0.16275024, 2.41506577], [0.1524353, 2.33760953], [0.14245605, 2.26010919], [0.1328125, 2.1825664], [0.12350655, 2.10498238], [0.11453629, 2.02735448], [0.10590363, 1.94969249], [0.09760857, 1.8719939], [0.0896492, 1.79426003], [0.08202934, 1.71649218], [0.07474709, 1.63869214], [0.06780243, 1.56085682], [0.06119537, 1.48299646], [0.05492592, 1.40510821], [0.04899597, 1.32719338], [0.04340363, 1.24925351], [0.03814888, 1.17129016], [0.03323364, 1.09330046], [0.02865601, 1.01529431], [0.02441788, 0.93726915], [0.02051926, 0.85922635], [0.01695824, 0.78116739], [0.01373672, 0.70309353], [0.01085472, 0.62500232], [0.00831032, 0.54690349], [0.00610542, 0.46879441], [0.00424004, 0.3906765], [0.00271416, 0.31255117], [0.00152588, 0.23442002], [0.00067902, 0.15628013], [0.00016975, 0.07814158], [0.0, -1.57e-06], [0.00016975, -0.07814158], [0.00067902, -0.15628013], [0.00152588, -0.23442002], [0.00271416, -0.31255117], [0.00424004, -0.3906765], [0.00610542, -0.46879441], [0.00831032, -0.54690349], [0.01085472, -0.62500232], [0.01373672, -0.70309353], [0.01695824, -0.78116739], [0.02051926, -0.85922635], [0.02441788, -0.93726915], [0.02865601, -1.01529431], [0.03323364, -1.09330046], [0.03814888, -1.17129016], [0.04340363, -1.24925351], [0.04899597, -1.32719338], [0.05492592, -1.40510821], [0.06119537, -1.48299646], [0.06780243, -1.56085682], [0.07474709, -1.63869214], [0.08202934, -1.71649218], [0.0896492, -1.79426003], [0.09760857, -1.8719939], [0.10590363, -1.94969249], [0.11453629, -2.02735448], [0.12350655, -2.10498238], [0.1328125, -2.1825664], [0.14245605, -2.26010919], [0.1524353, -2.33760953], [0.16275024, -2.41506577], [0.17340279, -2.49247646], [0.18439293, -2.56984448], [0.19571495, -2.64716005], [0.20737457, -2.72442532], [0.21936989, -2.80163956], [0.2317009, -2.87880063], [0.24436378, -2.95590782], [0.25736427, -3.03296328], [0.27069664, -3.10995746], [0.28436661, -3.18689322], [0.29836655, -3.26376867], [0.31270218, -3.34058261], [0.32736969, -3.41733384], [0.34237289, -3.49402475], [0.35770607, -3.57064533], [0.37337494, -3.64719892], [0.38937378, -3.7236836], [0.40570259, -3.80009842], [0.4223671, -3.87644148], [0.43936157, -3.95271564], [0.45668602, -4.02891111], [0.47434044, -4.10503054], [0.49232674, -4.18107271], [0.51064301, -4.25703621], [0.52928734, -4.33291912], [0.54826355, -4.40872478], [0.56756592, -4.48444319], [0.58719635, -4.56007719], [0.60715675, -4.63562536], [0.62744522, -4.71108532], [0.64806175, -4.78646135], [0.66900253, -4.86174297], [0.69027138, -4.93693352], [0.71186638, -5.01203012], [0.73378754, -5.08703232], [0.75603294, -5.16193914], [0.77860451, -5.2367487], [0.80150032, -5.31146336], [0.82472229, -5.38607407], [0.84826469, -5.46058321], [0.87213135, -5.53498936], [0.89632034, -5.60929108], [0.92083359, -5.68349171], [0.94566727, -5.75758076], [0.97082138, -5.83156061], [0.99629784, -5.90543127], [1.02209473, -5.97919035], [1.04821014, -6.05283737], [1.074646, -6.12636995], [1.10140228, -6.19979095], [1.12847519, -6.27309132], [1.15586662, -6.34627342], [1.18357468, -6.41933584], [1.21160126, -6.49227715], [1.23994446, -6.56510019], [1.26860237, -6.6377964], [1.297575, -6.71036625], [1.32686234, -6.78281021], [1.35646439, -6.8551259], [1.38638115, -6.92731285], [1.41661072, -6.99936914], [1.44715309, -7.07129765], [1.47800636, -7.14308882], [1.50917053, -7.21474552], [1.5406456, -7.28626585], [1.57243156, -7.35764885], [1.60452843, -7.42889786], [1.63693237, -7.50000191]]}]}, {"type": "surfaces", "data": [{"matrix": [[-1.0, 0.0, 14.77386366], [0.0, -1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[1.63693237, 7.50000191], [1.60452843, 7.42889786], [1.57243156, 7.35764885], [1.5406456, 7.28626585], [1.50917053, 7.21474552], [1.47800636, 7.14308882], [1.44715309, 7.07129765], [1.41661072, 6.99936914], [1.38638115, 6.92731285], [1.35646439, 6.8551259], [1.32686234, 6.78281021], [1.297575, 6.71036625], [1.26860237, 6.6377964], [1.23994446, 6.56510019], [1.21160126, 6.49227715], [1.18357468, 6.41933584], [1.15586662, 6.34627342], [1.12847519, 6.27309132], [1.10140228, 6.19979095], [1.074646, 6.12636995], [1.04821014, 6.05283737], [1.02209473, 5.97919035], [0.99629784, 5.90543127], [0.97082138, 5.83156061], [0.94566727, 5.75758076], [0.92083359, 5.68349171], [0.89632034, 5.60929108], [0.87213135, 5.53498936], [0.84826469, 5.46058321], [0.82472229, 5.38607407], [0.80150032, 5.31146336], [0.77860451, 5.2367487], [0.75603294, 5.16193914], [0.73378754, 5.08703232], [0.71186638, 5.01203012], [0.69027138, 4.93693352], [0.66900253, 4.86174297], [0.64806175, 4.78646135], [0.62744522, 4.71108532], [0.60715675, 4.63562536], [0.58719635, 4.56007719], [0.56756592, 4.48444319], [0.54826355, 4.40872478], [0.52928734, 4.33291912], [0.51064301, 4.25703621], [0.49232674, 4.18107271], [0.47434044, 4.10503054], [0.45668602, 4.02891111], [0.43936157, 3.95271564], [0.4223671, 3.87644148], [0.40570259, 3.80009842], [0.38937378, 3.7236836], [0.37337494, 3.64719892], [0.35770607, 3.57064533], [0.34237289, 3.49402475], [0.32736969, 3.41733384], [0.31270218, 3.34058261], [0.29836655, 3.26376867], [0.28436661, 3.18689322], [0.27069664, 3.10995746], [0.25736427, 3.03296328], [0.24436378, 2.95590782], [0.2317009, 2.87880063], [0.21936989, 2.80163956], [0.20737457, 2.72442532], [0.19571495, 2.64716005], [0.18439293, 2.56984448], [0.17340279, 2.49247646], [0.16275024, 2.41506577], [0.1524353, 2.33760953], [0.14245605, 2.26010919], [0.1328125, 2.1825664], [0.12350655, 2.10498238], [0.11453629, 2.02735448], [0.10590363, 1.94969249], [0.09760857, 1.8719939], [0.0896492, 1.79426003], [0.08202934, 1.71649218], [0.07474709, 1.63869214], [0.06780243, 1.56085682], [0.06119537, 1.48299646], [0.05492592, 1.40510821], [0.04899597, 1.32719338], [0.04340363, 1.24925351], [0.03814888, 1.17129016], [0.03323364, 1.09330046], [0.02865601, 1.01529431], [0.02441788, 0.93726915], [0.02051926, 0.85922635], [0.01695824, 0.78116739], [0.01373672, 0.70309353], [0.01085472, 0.62500232], [0.00831032, 0.54690349], [0.00610542, 0.46879441], [0.00424004, 0.3906765], [0.00271416, 0.31255117], [0.00152588, 0.23442002], [0.00067902, 0.15628013], [0.00016975, 0.07814158], [0.0, -1.57e-06], [0.00016975, -0.07814158], [0.00067902, -0.15628013], [0.00152588, -0.23442002], [0.00271416, -0.31255117], [0.00424004, -0.3906765], [0.00610542, -0.46879441], [0.00831032, -0.54690349], [0.01085472, -0.62500232], [0.01373672, -0.70309353], [0.01695824, -0.78116739], [0.02051926, -0.85922635], [0.02441788, -0.93726915], [0.02865601, -1.01529431], [0.03323364, -1.09330046], [0.03814888, -1.17129016], [0.04340363, -1.24925351], [0.04899597, -1.32719338], [0.05492592, -1.40510821], [0.06119537, -1.48299646], [0.06780243, -1.56085682], [0.07474709, -1.63869214], [0.08202934, -1.71649218], [0.0896492, -1.79426003], [0.09760857, -1.8719939], [0.10590363, -1.94969249], [0.11453629, -2.02735448], [0.12350655, -2.10498238], [0.1328125, -2.1825664], [0.14245605, -2.26010919], [0.1524353, -2.33760953], [0.16275024, -2.41506577], [0.17340279, -2.49247646], [0.18439293, -2.56984448], [0.19571495, -2.64716005], [0.20737457, -2.72442532], [0.21936989, -2.80163956], [0.2317009, -2.87880063], [0.24436378, -2.95590782], [0.25736427, -3.03296328], [0.27069664, -3.10995746], [0.28436661, -3.18689322], [0.29836655, -3.26376867], [0.31270218, -3.34058261], [0.32736969, -3.41733384], [0.34237289, -3.49402475], [0.35770607, -3.57064533], [0.37337494, -3.64719892], [0.38937378, -3.7236836], [0.40570259, -3.80009842], [0.4223671, -3.87644148], [0.43936157, -3.95271564], [0.45668602, -4.02891111], [0.47434044, -4.10503054], [0.49232674, -4.18107271], [0.51064301, -4.25703621], [0.52928734, -4.33291912], [0.54826355, -4.40872478], [0.56756592, -4.48444319], [0.58719635, -4.56007719], [0.60715675, -4.63562536], [0.62744522, -4.71108532], [0.64806175, -4.78646135], [0.66900253, -4.86174297], [0.69027138, -4.93693352], [0.71186638, -5.01203012], [0.73378754, -5.08703232], [0.75603294, -5.16193914], [0.77860451, -5.2367487], [0.80150032, -5.31146336], [0.82472229, -5.38607407], [0.84826469, -5.46058321], [0.87213135, -5.53498936], [0.89632034, -5.60929108], [0.92083359, -5.68349171], [0.94566727, -5.75758076], [0.97082138, -5.83156061], [0.99629784, -5.90543127], [1.02209473, -5.97919035], [1.04821014, -6.05283737], [1.074646, -6.12636995], [1.10140228, -6.19979095], [1.12847519, -6.27309132], [1.15586662, -6.34627342], [1.18357468, -6.41933584], [1.21160126, -6.49227715], [1.23994446, -6.56510019], [1.26860237, -6.6377964], [1.297575, -6.71036625], [1.32686234, -6.78281021], [1.35646439, -6.8551259], [1.38638115, -6.92731285], [1.41661072, -6.99936914], [1.44715309, -7.07129765], [1.47800636, -7.14308882], [1.50917053, -7.21474552], [1.5406456, -7.28626585], [1.57243156, -7.35764885], [1.60452843, -7.42889786], [1.63693237, -7.50000191]]}]}, {"type": "points", "data": [[44.77386366, 0.0]], "color": "red"}, {"type": "rays", "points": [[0.0, 17.9, 10.28802604, 3.20717611]], "color": "#ffa724", "variables": {}, "domain": {}, "layers": [1]}, {"type": "rays", "points": [[10.28802604, 3.20717611, 14.7723338, 0.23467549]], "color": "#ffa724", "variables": {}, "domain": {}, "layers": [1]}, {"type": "rays", "points": [[14.7723338, 0.23467549, 15.16349153, -29.76522221]], "color": "#ffa724", "variables": {}, "domain": {}}, {"type": "points", "data": [[0.0, 0.0], [10.0, 0.0], [11.63693183, 0.0], [13.13693183, 0.0], [14.77386366, 0.0], [44.77386366, 0.0]], "layers": [4]}, {"type": "rays", "points": [[14.7723338, 0.23467549, 14.90270907, -9.76447459]], "color": "#ffa724", "variables": {}, "domain": {}, "layers": [3]}]}';

tlmviewer.embed(document.getElementById("tlmviewer-929e921d"), data);    
</script>



```python
### BUG V1
# happens no matter when the critical_angle argument is

import torch
import torch.nn as nn
import torch.optim as optim
import torchlensmaker as tlm


class Debug(nn.Module):
    def __init__(self):
        super().__init__()

    def forward(self, x):
        print(x.P.shape)
        return x

surface = tlm.surfaces.Sphere(diameter=15, r=tlm.parameter(15))
lens = tlm.BiLens(surface, material="SF10-nd", outer_thickness=1.5)

optics = nn.Sequential(
    tlm.PointSourceAtInfinity(beam_diameter=18.5),
    Debug(),
    tlm.Gap(10),
    lens,
    Debug(),
    tlm.Gap(30),
    tlm.FocalPoint(),
)


lens.surface2.element[1].critical_angle = "drop"


tlm.show(optics, dim=2, sampling={"base": 10})
```

    torch.Size([10, 2])
    torch.Size([6, 2])



<div data-jp-suppress-context-menu id='tlmviewer-c804787e' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 10.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[2.00962067, 7.50000286], [1.97013474, 7.43119097], [1.93101406, 7.36217451], [1.8922596, 7.29295206], [1.8538723, 7.223526], [1.81585217, 7.15389776], [1.7781992, 7.08406591], [1.74091816, 7.01403904], [1.70400715, 6.94381618], [1.66746902, 6.87339878], [1.63130379, 6.80278969], [1.59551144, 6.73198986], [1.56009483, 6.66100168], [1.52505207, 6.5898242], [1.49038792, 6.51846552], [1.45610237, 6.44692469], [1.42219448, 6.37520313], [1.38866806, 6.30330324], [1.3555212, 6.2312274], [1.32275677, 6.15897751], [1.29037189, 6.08655119], [1.25837326, 6.01395893], [1.22675896, 5.9411974], [1.19552898, 5.8682704], [1.1646862, 5.79517889], [1.13423061, 5.72192574], [1.10416222, 5.64851236], [1.07448101, 5.57493734], [1.04519081, 5.50120974], [1.01629162, 5.42732811], [0.98778248, 5.35329533], [0.9596653, 5.27911282], [0.93194103, 5.20477867], [0.90461063, 5.13030243], [0.8776741, 5.05568266], [0.85113335, 4.98092175], [0.82498837, 4.90602112], [0.79923916, 4.83098412], [0.77388763, 4.75581074], [0.74893379, 4.68050146], [0.72437763, 4.60506487], [0.70022297, 4.52949953], [0.67646694, 4.45380735], [0.65311146, 4.37799072], [0.63015842, 4.30205154], [0.60760593, 4.22599173], [0.58545685, 4.14981031], [0.56371021, 4.07351637], [0.54236794, 3.9971087], [0.52143002, 3.92058897], [0.50089741, 3.84395957], [0.48076916, 3.76721931], [0.46104813, 3.69037724], [0.44173431, 3.61343169], [0.42282677, 3.5363853], [0.40432739, 3.45923972], [0.38623619, 3.38199759], [0.36855316, 3.3046608], [0.35128021, 3.22722816], [0.33441734, 3.14970875], [0.3179636, 3.07210088], [0.30192089, 2.99440742], [0.28629017, 2.91663027], [0.27107048, 2.83877134], [0.25626278, 2.76083302], [0.24186611, 2.68281412], [0.22788429, 2.60472345], [0.21431446, 2.52656007], [0.20115852, 2.44832587], [0.18841743, 2.37002325], [0.17608833, 2.29165101], [0.16417599, 2.21321797], [0.15267849, 2.13472319], [0.14159584, 2.05616856], [0.13092899, 1.97755647], [0.12067795, 1.89888906], [0.11084366, 1.8201685], [0.10142517, 1.74139345], [0.09242344, 1.66257334], [0.08383846, 1.58370662], [0.0756712, 1.50479567], [0.06792164, 1.42584264], [0.06058884, 1.34684968], [0.0536747, 1.26781905], [0.04717827, 1.18874943], [0.0411005, 1.10965014], [0.03544044, 1.03051984], [0.0302, 0.95136052], [0.02537823, 0.87217474], [0.02097511, 0.79296458], [0.01698971, 0.71372861], [0.01342487, 0.63447624], [0.0102787, 0.55520612], [0.00755215, 0.47592056], [0.00524426, 0.39662158], [0.00335598, 0.31731158], [0.00188828, 0.23798911], [0.00083923, 0.15866353], [0.00020981, 0.07933354], [0.0, -1.31e-06], [0.00020981, -0.07933354], [0.00083923, -0.15866353], [0.00188828, -0.23798911], [0.00335598, -0.31731158], [0.00524426, -0.39662158], [0.00755215, -0.47592056], [0.0102787, -0.55520612], [0.01342487, -0.63447624], [0.01698971, -0.71372861], [0.02097511, -0.79296458], [0.02537823, -0.87217474], [0.0302, -0.95136052], [0.03544044, -1.03051984], [0.0411005, -1.10965014], [0.04717827, -1.18874943], [0.0536747, -1.26781905], [0.06058884, -1.34684968], [0.06792164, -1.42584264], [0.0756712, -1.50479567], [0.08383846, -1.58370662], [0.09242344, -1.66257334], [0.10142517, -1.74139345], [0.11084366, -1.8201685], [0.12067795, -1.89888906], [0.13092899, -1.97755647], [0.14159584, -2.05616856], [0.15267849, -2.13472319], [0.16417599, -2.21321797], [0.17608833, -2.29165101], [0.18841743, -2.37002325], [0.20115852, -2.44832587], [0.21431446, -2.52656007], [0.22788429, -2.60472345], [0.24186611, -2.68281412], [0.25626278, -2.76083302], [0.27107048, -2.83877134], [0.28629017, -2.91663027], [0.30192089, -2.99440742], [0.3179636, -3.07210088], [0.33441734, -3.14970875], [0.35128021, -3.22722816], [0.36855316, -3.3046608], [0.38623619, -3.38199759], [0.40432739, -3.45923972], [0.42282677, -3.5363853], [0.44173431, -3.61343169], [0.46104813, -3.69037724], [0.48076916, -3.76721931], [0.50089741, -3.84395957], [0.52143002, -3.92058897], [0.54236794, -3.9971087], [0.56371021, -4.07351637], [0.58545685, -4.14981031], [0.60760593, -4.22599173], [0.63015842, -4.30205154], [0.65311146, -4.37799072], [0.67646694, -4.45380735], [0.70022297, -4.52949953], [0.72437763, -4.60506487], [0.74893379, -4.68050146], [0.77388763, -4.75581074], [0.79923916, -4.83098412], [0.82498837, -4.90602112], [0.85113335, -4.98092175], [0.8776741, -5.05568266], [0.90461063, -5.13030243], [0.93194103, -5.20477867], [0.9596653, -5.27911282], [0.98778248, -5.35329533], [1.01629162, -5.42732811], [1.04519081, -5.50120974], [1.07448101, -5.57493734], [1.10416222, -5.64851236], [1.13423061, -5.72192574], [1.1646862, -5.79517889], [1.19552898, -5.8682704], [1.22675896, -5.9411974], [1.25837326, -6.01395893], [1.29037189, -6.08655119], [1.32275677, -6.15897751], [1.3555212, -6.2312274], [1.38866806, -6.30330324], [1.42219448, -6.37520313], [1.45610237, -6.44692469], [1.49038792, -6.51846552], [1.52505207, -6.5898242], [1.56009483, -6.66100168], [1.59551144, -6.73198986], [1.63130379, -6.80278969], [1.66746902, -6.87339878], [1.70400715, -6.94381618], [1.74091816, -7.01403904], [1.7781992, -7.08406591], [1.81585217, -7.15389776], [1.8538723, -7.223526], [1.8922596, -7.29295206], [1.93101406, -7.36217451], [1.97013474, -7.43119097], [2.00962067, -7.50000286]]}]}, {"type": "surfaces", "data": [{"matrix": [[-1.0, 0.0, 15.51923789], [0.0, -1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[2.00962067, 7.50000286], [1.97013474, 7.43119097], [1.93101406, 7.36217451], [1.8922596, 7.29295206], [1.8538723, 7.223526], [1.81585217, 7.15389776], [1.7781992, 7.08406591], [1.74091816, 7.01403904], [1.70400715, 6.94381618], [1.66746902, 6.87339878], [1.63130379, 6.80278969], [1.59551144, 6.73198986], [1.56009483, 6.66100168], [1.52505207, 6.5898242], [1.49038792, 6.51846552], [1.45610237, 6.44692469], [1.42219448, 6.37520313], [1.38866806, 6.30330324], [1.3555212, 6.2312274], [1.32275677, 6.15897751], [1.29037189, 6.08655119], [1.25837326, 6.01395893], [1.22675896, 5.9411974], [1.19552898, 5.8682704], [1.1646862, 5.79517889], [1.13423061, 5.72192574], [1.10416222, 5.64851236], [1.07448101, 5.57493734], [1.04519081, 5.50120974], [1.01629162, 5.42732811], [0.98778248, 5.35329533], [0.9596653, 5.27911282], [0.93194103, 5.20477867], [0.90461063, 5.13030243], [0.8776741, 5.05568266], [0.85113335, 4.98092175], [0.82498837, 4.90602112], [0.79923916, 4.83098412], [0.77388763, 4.75581074], [0.74893379, 4.68050146], [0.72437763, 4.60506487], [0.70022297, 4.52949953], [0.67646694, 4.45380735], [0.65311146, 4.37799072], [0.63015842, 4.30205154], [0.60760593, 4.22599173], [0.58545685, 4.14981031], [0.56371021, 4.07351637], [0.54236794, 3.9971087], [0.52143002, 3.92058897], [0.50089741, 3.84395957], [0.48076916, 3.76721931], [0.46104813, 3.69037724], [0.44173431, 3.61343169], [0.42282677, 3.5363853], [0.40432739, 3.45923972], [0.38623619, 3.38199759], [0.36855316, 3.3046608], [0.35128021, 3.22722816], [0.33441734, 3.14970875], [0.3179636, 3.07210088], [0.30192089, 2.99440742], [0.28629017, 2.91663027], [0.27107048, 2.83877134], [0.25626278, 2.76083302], [0.24186611, 2.68281412], [0.22788429, 2.60472345], [0.21431446, 2.52656007], [0.20115852, 2.44832587], [0.18841743, 2.37002325], [0.17608833, 2.29165101], [0.16417599, 2.21321797], [0.15267849, 2.13472319], [0.14159584, 2.05616856], [0.13092899, 1.97755647], [0.12067795, 1.89888906], [0.11084366, 1.8201685], [0.10142517, 1.74139345], [0.09242344, 1.66257334], [0.08383846, 1.58370662], [0.0756712, 1.50479567], [0.06792164, 1.42584264], [0.06058884, 1.34684968], [0.0536747, 1.26781905], [0.04717827, 1.18874943], [0.0411005, 1.10965014], [0.03544044, 1.03051984], [0.0302, 0.95136052], [0.02537823, 0.87217474], [0.02097511, 0.79296458], [0.01698971, 0.71372861], [0.01342487, 0.63447624], [0.0102787, 0.55520612], [0.00755215, 0.47592056], [0.00524426, 0.39662158], [0.00335598, 0.31731158], [0.00188828, 0.23798911], [0.00083923, 0.15866353], [0.00020981, 0.07933354], [0.0, -1.31e-06], [0.00020981, -0.07933354], [0.00083923, -0.15866353], [0.00188828, -0.23798911], [0.00335598, -0.31731158], [0.00524426, -0.39662158], [0.00755215, -0.47592056], [0.0102787, -0.55520612], [0.01342487, -0.63447624], [0.01698971, -0.71372861], [0.02097511, -0.79296458], [0.02537823, -0.87217474], [0.0302, -0.95136052], [0.03544044, -1.03051984], [0.0411005, -1.10965014], [0.04717827, -1.18874943], [0.0536747, -1.26781905], [0.06058884, -1.34684968], [0.06792164, -1.42584264], [0.0756712, -1.50479567], [0.08383846, -1.58370662], [0.09242344, -1.66257334], [0.10142517, -1.74139345], [0.11084366, -1.8201685], [0.12067795, -1.89888906], [0.13092899, -1.97755647], [0.14159584, -2.05616856], [0.15267849, -2.13472319], [0.16417599, -2.21321797], [0.17608833, -2.29165101], [0.18841743, -2.37002325], [0.20115852, -2.44832587], [0.21431446, -2.52656007], [0.22788429, -2.60472345], [0.24186611, -2.68281412], [0.25626278, -2.76083302], [0.27107048, -2.83877134], [0.28629017, -2.91663027], [0.30192089, -2.99440742], [0.3179636, -3.07210088], [0.33441734, -3.14970875], [0.35128021, -3.22722816], [0.36855316, -3.3046608], [0.38623619, -3.38199759], [0.40432739, -3.45923972], [0.42282677, -3.5363853], [0.44173431, -3.61343169], [0.46104813, -3.69037724], [0.48076916, -3.76721931], [0.50089741, -3.84395957], [0.52143002, -3.92058897], [0.54236794, -3.9971087], [0.56371021, -4.07351637], [0.58545685, -4.14981031], [0.60760593, -4.22599173], [0.63015842, -4.30205154], [0.65311146, -4.37799072], [0.67646694, -4.45380735], [0.70022297, -4.52949953], [0.72437763, -4.60506487], [0.74893379, -4.68050146], [0.77388763, -4.75581074], [0.79923916, -4.83098412], [0.82498837, -4.90602112], [0.85113335, -4.98092175], [0.8776741, -5.05568266], [0.90461063, -5.13030243], [0.93194103, -5.20477867], [0.9596653, -5.27911282], [0.98778248, -5.35329533], [1.01629162, -5.42732811], [1.04519081, -5.50120974], [1.07448101, -5.57493734], [1.10416222, -5.64851236], [1.13423061, -5.72192574], [1.1646862, -5.79517889], [1.19552898, -5.8682704], [1.22675896, -5.9411974], [1.25837326, -6.01395893], [1.29037189, -6.08655119], [1.32275677, -6.15897751], [1.3555212, -6.2312274], [1.38866806, -6.30330324], [1.42219448, -6.37520313], [1.45610237, -6.44692469], [1.49038792, -6.51846552], [1.52505207, -6.5898242], [1.56009483, -6.66100168], [1.59551144, -6.73198986], [1.63130379, -6.80278969], [1.66746902, -6.87339878], [1.70400715, -6.94381618], [1.74091816, -7.01403904], [1.7781992, -7.08406591], [1.81585217, -7.15389776], [1.8538723, -7.223526], [1.8922596, -7.29295206], [1.93101406, -7.36217451], [1.97013474, -7.43119097], [2.00962067, -7.50000286]]}]}, {"type": "points", "data": [[45.51923789, 0.0]], "color": "red"}, {"type": "rays", "points": [[0.0, -7.19444444, 11.83793447, -7.19444444], [0.0, -5.13888889, 10.90773897, -5.13888889], [0.0, -3.08333333, 10.32031827, -3.08333333], [0.0, -1.02777778, 10.03525233, -1.02777778], [0.0, 1.02777778, 10.03525233, 1.02777778], [0.0, 3.08333333, 10.32031827, 3.08333333], [0.0, 5.13888889, 10.90773897, 5.13888889], [0.0, 7.19444444, 11.83793447, 7.19444444]], "color": "#ffa724", "variables": {"base": [-7.19444444, -5.13888889, -3.08333333, -1.02777778, 1.02777778, 3.08333333, 5.13888889, 7.19444444]}, "domain": {"base": [-9.25, 9.25]}, "layers": [1]}, {"type": "rays", "points": [[0.0, -9.25, 10.0, -9.25], [0.0, 9.25, 10.0, 9.25]], "color": "red", "variables": {"base": [-9.25, 9.25]}, "domain": {"base": [-9.25, 9.25]}, "layers": [2]}, {"type": "rays", "points": [[11.83793447, -7.19444444, 13.93542178, -6.70865186], [10.90773897, -5.13888889, 14.82111128, -4.52287713], [10.32031827, -3.08333333, 15.28718821, -2.62823956], [10.03525233, -1.02777778, 15.49436657, -0.86343548], [10.03525233, 1.02777778, 15.49436657, 0.86343548], [10.32031827, 3.08333333, 15.28718821, 2.62823956], [10.90773897, 5.13888889, 14.82111128, 4.52287713], [11.83793447, 7.19444444, 13.93542178, 6.70865186]], "color": "#ffa724", "variables": {"base": [-7.19444444, -5.13888889, -3.08333333, -1.02777778, 1.02777778, 3.08333333, 5.13888889, 7.19444444]}, "domain": {"base": [-9.25, 9.25]}, "layers": [1]}, {"type": "rays", "points": [[14.82111128, -4.52287713, 40.21707212, 13.30621616], [15.28718821, -2.62823956, 44.14882346, 6.74675278], [15.49436657, -0.86343548, 45.38446148, 2.10652154], [15.49436657, 0.86343548, 45.38446148, -2.10652154], [15.28718821, 2.62823956, 44.14882346, -6.74675278], [14.82111128, 4.52287713, 40.21707212, -13.30621616]], "color": "#ffa724", "variables": {"base": [-5.13888889, -3.08333333, -1.02777778, 1.02777778, 3.08333333, 5.13888889]}, "domain": {"base": [-9.25, 9.25]}}, {"type": "points", "data": [[0.0, 0.0], [10.0, 0.0], [12.00961894, 0.0], [13.50961894, 0.0], [15.51923789, 0.0], [45.51923789, 0.0]], "layers": [4]}]}';

tlmviewer.embed(document.getElementById("tlmviewer-c804787e"), data);    
</script>



```python
### BUG V2
# reproduction without lens

# bug:
# SF10-nd / clamp       : bug
# SF10-nd / drop        : bug maybe different
# SF10-nd / reflect     : unknown
# SF10-nd / nan         : json error

# no bug:
# water-nd / any

import torch
import torch.nn as nn
import torch.optim as optim
import torchlensmaker as tlm

surface = tlm.surfaces.Sphere(diameter=15, r=-18)

optics = nn.Sequential(
    tlm.Offset(
        tlm.Rotate(
            tlm.RaySource(material="SF10-nd"),
            [-20, 0]),
        y=10),
    tlm.Gap(10),
    tlm.RefractiveSurface(surface, material="air", anchors=("origin", "origin"), critical_angle="clamp"),
    tlm.Gap(30),
    tlm.FocalPoint(),
)


tlm.show(optics, dim=2, sampling={"base": 10})
```


<div data-jp-suppress-context-menu id='tlmviewer-04790a21' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 10.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[-1.63693237, -7.5], [-1.60452652, -7.428895], [-1.57243156, -7.35764885], [-1.5406456, -7.28626537], [-1.50917053, -7.21474409], [-1.47800636, -7.14308691], [-1.44715118, -7.07129526], [-1.41661072, -6.99936962], [-1.38638115, -6.92731333], [-1.35646439, -6.8551259], [-1.32686234, -6.78280878], [-1.297575, -6.71036434], [-1.26860046, -6.63779354], [-1.23994255, -6.56509686], [-1.21160126, -6.49227715], [-1.18357468, -6.41933584], [-1.15586662, -6.34627151], [-1.12847519, -6.27308941], [-1.10140228, -6.19978905], [-1.074646, -6.12637043], [-1.04821014, -6.05283737], [-1.02209473, -5.97918987], [-0.99629784, -5.90542984], [-0.97082138, -5.8315587], [-0.94566727, -5.75757742], [-0.92083168, -5.68348789], [-0.89632034, -5.60929108], [-0.87213135, -5.5349884], [-0.84826279, -5.46058178], [-0.82472038, -5.38607216], [-0.80150032, -5.31146049], [-0.77860451, -5.23674917], [-0.75603294, -5.16193867], [-0.73378754, -5.08703136], [-0.71186638, -5.01202869], [-0.69027138, -4.93693066], [-0.66900253, -4.86174059], [-0.64805984, -4.78645849], [-0.62744522, -4.71108484], [-0.60715675, -4.63562441], [-0.58719635, -4.56007576], [-0.56756592, -4.4844408], [-0.54826164, -4.40872192], [-0.52928734, -4.3329196], [-0.51064301, -4.25703573], [-0.49232674, -4.18107176], [-0.47434044, -4.10502863], [-0.45668411, -4.02890825], [-0.43935966, -3.95271254], [-0.4223671, -3.87644172], [-0.40570259, -3.80009818], [-0.38937378, -3.72368288], [-0.37337494, -3.64719748], [-0.35770607, -3.57064319], [-0.34237289, -3.49402142], [-0.3273716, -3.41733432], [-0.31270218, -3.34058237], [-0.29836655, -3.26376772], [-0.2843647, -3.18689132], [-0.27069664, -3.10995531], [-0.25736237, -3.03296041], [-0.24436378, -2.95590806], [-0.23169899, -2.87880039], [-0.21936989, -2.80163836], [-0.20737457, -2.72442341], [-0.19571495, -2.64715743], [-0.18439102, -2.56984138], [-0.17340279, -2.4924767], [-0.16275024, -2.41506529], [-0.1524353, -2.33760834], [-0.14245605, -2.26010728], [-0.1328125, -2.18256378], [-0.12350464, -2.10497904], [-0.11453629, -2.02735448], [-0.10590363, -1.94969201], [-0.09760857, -1.87199259], [-0.0896492, -1.794258], [-0.08202934, -1.71648955], [-0.07474709, -1.63868856], [-0.06780243, -1.56085706], [-0.06119537, -1.48299587], [-0.05492592, -1.40510678], [-0.04899597, -1.32719123], [-0.04340363, -1.24925077], [-0.03814888, -1.1712867], [-0.03323364, -1.09330046], [-0.02865601, -1.01529372], [-0.02441788, -0.93726778], [-0.02051926, -0.85922426], [-0.01695824, -0.78116447], [-0.01373672, -0.70309001], [-0.01085472, -0.62500226], [-0.00831032, -0.54690272], [-0.00610542, -0.46879292], [-0.00424004, -0.39067426], [-0.00271416, -0.31254822], [-0.00152588, -0.23441634], [-0.00067902, -0.15628001], [-0.00016975, -0.07814074], [0.0, 0.0], [-0.00016975, 0.07814074], [-0.00067902, 0.15628001], [-0.00152588, 0.23441634], [-0.00271416, 0.31254822], [-0.00424004, 0.39067426], [-0.00610542, 0.46879292], [-0.00831032, 0.54690272], [-0.01085472, 0.62500226], [-0.01373672, 0.70309001], [-0.01695824, 0.78116447], [-0.02051926, 0.85922426], [-0.02441788, 0.93726778], [-0.02865601, 1.01529372], [-0.03323364, 1.09330046], [-0.03814888, 1.1712867], [-0.04340363, 1.24925077], [-0.04899597, 1.32719123], [-0.05492592, 1.40510678], [-0.06119537, 1.48299587], [-0.06780243, 1.56085706], [-0.07474709, 1.63868856], [-0.08202934, 1.71648955], [-0.0896492, 1.794258], [-0.09760857, 1.87199259], [-0.10590363, 1.94969201], [-0.11453629, 2.02735448], [-0.12350464, 2.10497904], [-0.1328125, 2.18256378], [-0.14245605, 2.26010728], [-0.1524353, 2.33760834], [-0.16275024, 2.41506529], [-0.17340279, 2.4924767], [-0.18439102, 2.56984138], [-0.19571495, 2.64715743], [-0.20737457, 2.72442341], [-0.21936989, 2.80163836], [-0.23169899, 2.87880039], [-0.24436378, 2.95590806], [-0.25736237, 3.03296041], [-0.27069664, 3.10995531], [-0.2843647, 3.18689132], [-0.29836655, 3.26376772], [-0.31270218, 3.34058237], [-0.3273716, 3.41733432], [-0.34237289, 3.49402142], [-0.35770607, 3.57064319], [-0.37337494, 3.64719748], [-0.38937378, 3.72368288], [-0.40570259, 3.80009818], [-0.4223671, 3.87644172], [-0.43935966, 3.95271254], [-0.45668411, 4.02890825], [-0.47434044, 4.10502863], [-0.49232674, 4.18107176], [-0.51064301, 4.25703573], [-0.52928734, 4.3329196], [-0.54826164, 4.40872192], [-0.56756592, 4.4844408], [-0.58719635, 4.56007576], [-0.60715675, 4.63562441], [-0.62744522, 4.71108484], [-0.64805984, 4.78645849], [-0.66900253, 4.86174059], [-0.69027138, 4.93693066], [-0.71186638, 5.01202869], [-0.73378754, 5.08703136], [-0.75603294, 5.16193867], [-0.77860451, 5.23674917], [-0.80150032, 5.31146049], [-0.82472038, 5.38607216], [-0.84826279, 5.46058178], [-0.87213135, 5.5349884], [-0.89632034, 5.60929108], [-0.92083168, 5.68348789], [-0.94566727, 5.75757742], [-0.97082138, 5.8315587], [-0.99629784, 5.90542984], [-1.02209473, 5.97918987], [-1.04821014, 6.05283737], [-1.074646, 6.12637043], [-1.10140228, 6.19978905], [-1.12847519, 6.27308941], [-1.15586662, 6.34627151], [-1.18357468, 6.41933584], [-1.21160126, 6.49227715], [-1.23994255, 6.56509686], [-1.26860046, 6.63779354], [-1.297575, 6.71036434], [-1.32686234, 6.78280878], [-1.35646439, 6.8551259], [-1.38638115, 6.92731333], [-1.41661072, 6.99936962], [-1.44715118, 7.07129526], [-1.47800636, 7.14308691], [-1.50917053, 7.21474409], [-1.5406456, 7.28626537], [-1.57243156, 7.35764885], [-1.60452652, 7.428895], [-1.63693237, 7.5]]}]}, {"type": "points", "data": [[40.0, 0.0]], "color": "red"}, {"type": "rays", "points": [[0.0, 10.0, 8.64407504, 6.85381398]], "color": "#ffa724", "variables": {}, "domain": {}, "layers": [1]}, {"type": "rays", "points": [[8.64407504, 6.85381398, 20.86527932, -22.82464558]], "color": "#ffa724", "variables": {}, "domain": {}}, {"type": "points", "data": [[0.0, 0.0], [10.0, 0.0], [40.0, 0.0]], "layers": [4]}]}';

tlmviewer.embed(document.getElementById("tlmviewer-04790a21"), data);    
</script>

