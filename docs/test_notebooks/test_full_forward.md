```python
import torch
import torch.nn as nn
import torchlensmaker as tlm
import torch.optim as optim

# y = a*x^2
surface = tlm.surfaces.Parabola(diameter=15, a=tlm.parameter(0.015))

lens = tlm.BiLens(surface, material="BK7", outer_thickness=1.0)

optics = nn.Sequential(
    tlm.PointSourceAtInfinity(beam_diameter=18.5),
    tlm.ChromaticRange(500, 800),
    tlm.Gap(10),
    lens,
    tlm.Gap(50),
    tlm.FocalPoint(),
)

print(optics)
```

    Sequential(
      (0): PointSourceAtInfinity()
      (1): ChromaticRange()
      (2): Gap()
      (3): BiLens(
        (surface1): RefractiveSurface(
          (element): Sequential(
            (0): CollisionSurface()
            (1): RefractiveBoundary()
          )
        )
        (gap): Gap()
        (surface2): RefractiveSurface(
          (element): Sequential(
            (0): CollisionSurface()
            (1): RefractiveBoundary()
          )
        )
      )
      (4): Gap()
      (5): FocalPoint()
    )



```python
s1 = tlm.Sphere(diameter=15, r=7.5)

optics = tlm.Sequential(
    tlm.PointSource(beam_angular_size=20),
    tlm.Gap(15),
    tlm.KinematicSurface(nn.Sequential(
        tlm.CollisionSurface(s1),
        tlm.RefractiveBoundary("SF10-nd", "clamp"),
    ), s1, anchors=("origin", "extent")),

    tlm.KinematicSurface(nn.Sequential(
        
        tlm.CollisionSurface(s1),
        tlm.RefractiveBoundary("air", "clamp"),
        
    ), s1, scale=-1, anchors=("extent", "origin")),
)

tlm.show(optics, dim=2, end=20)
```


<div data-jp-suppress-context-menu id='tlmviewer-eda4c397' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 15.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[7.5, 7.5], [7.38100815, 7.49905586], [7.26204205, 7.49622393], [7.1431365, 7.49150515], [7.0243206, 7.4849], [6.90562439, 7.47641087], [6.78708124, 7.46603966], [6.66871405, 7.45378876], [6.55055618, 7.43966103], [6.43264103, 7.42366123], [6.314991, 7.40579176], [6.19763899, 7.38605833], [6.08061886, 7.36446571], [5.96395206, 7.34101868], [5.84767199, 7.3157239], [5.73180819, 7.28858709], [5.61638927, 7.25961494], [5.50144815, 7.22881651], [5.38700676, 7.19619751], [5.27309704, 7.16176653], [5.15975189, 7.12553406], [5.04699183, 7.08750677], [4.93484974, 7.04769516], [4.82335281, 7.00610876], [4.71253014, 6.96275902], [4.6024127, 6.91765738], [4.49302101, 6.87081385], [4.38438702, 6.82223988], [4.2765398, 6.77195024], [4.1695013, 6.71995354], [4.06330109, 6.66626549], [3.95796943, 6.61090136], [3.85352612, 6.55387115], [3.75000072, 6.49519062], [3.64741945, 6.43487549], [3.54580784, 6.37294006], [3.4451952, 6.30940247], [3.34560013, 6.24427414], [3.24705076, 6.17757416], [3.14957523, 6.10932112], [3.05319166, 6.03952789], [2.9579277, 5.96821404], [2.8638072, 5.89539814], [2.77085638, 5.82109976], [2.67909384, 5.74533415], [2.58854437, 5.66812181], [2.49923325, 5.58948421], [2.4111805, 5.50943947], [2.32440805, 5.42800617], [2.23893833, 5.34520626], [2.15479422, 5.26106215], [2.07199574, 5.17559385], [1.99056244, 5.08882093], [1.91051626, 5.00076723], [1.83187866, 4.91145611], [1.75466776, 4.82090807], [1.67890167, 4.72914553], [1.60460234, 4.63619328], [1.53178644, 4.54207277], [1.46047401, 4.44681072], [1.39068079, 4.35042667], [1.32242584, 4.25294971], [1.25572634, 4.15440083], [1.19059896, 4.05480719], [1.12705946, 3.95419121], [1.06512499, 3.85258102], [1.00481033, 3.75000143], [0.9461298, 3.64647603], [0.8890996, 3.54203296], [0.83373451, 3.43669939], [0.78004742, 3.33050084], [0.72805119, 3.22346234], [0.6777606, 3.1156137], [0.62918663, 3.00697947], [0.5823431, 2.89758945], [0.53724051, 2.78746867], [0.49389124, 2.67664766], [0.45230532, 2.56515121], [0.41249418, 2.45301056], [0.3744669, 2.34025073], [0.33823347, 2.22690368], [0.30380297, 2.11299586], [0.27118397, 1.99855435], [0.24038458, 1.88360965], [0.21141338, 1.76819265], [0.18427658, 1.6523304], [0.1589818, 1.53605044], [0.13553524, 1.41938567], [0.11394215, 1.30236173], [0.09420872, 1.18501163], [0.07633924, 1.06736159], [0.06033897, 0.94944453], [0.04621172, 0.83128667], [0.03396082, 0.71292132], [0.02358913, 0.59437472], [0.0151, 0.47568026], [0.00849485, 0.3568643], [0.00377607, 0.23796028], [0.00094414, 0.11899456], [0.0, -6.6e-07], [0.00094414, -0.11899456], [0.00377607, -0.23796028], [0.00849485, -0.3568643], [0.0151, -0.47568026], [0.02358913, -0.59437472], [0.03396082, -0.71292132], [0.04621172, -0.83128667], [0.06033897, -0.94944453], [0.07633924, -1.06736159], [0.09420872, -1.18501163], [0.11394215, -1.30236173], [0.13553524, -1.41938567], [0.1589818, -1.53605044], [0.18427658, -1.6523304], [0.21141338, -1.76819265], [0.24038458, -1.88360965], [0.27118397, -1.99855435], [0.30380297, -2.11299586], [0.33823347, -2.22690368], [0.3744669, -2.34025073], [0.41249418, -2.45301056], [0.45230532, -2.56515121], [0.49389124, -2.67664766], [0.53724051, -2.78746867], [0.5823431, -2.89758945], [0.62918663, -3.00697947], [0.6777606, -3.1156137], [0.72805119, -3.22346234], [0.78004742, -3.33050084], [0.83373451, -3.43669939], [0.8890996, -3.54203296], [0.9461298, -3.64647603], [1.00481033, -3.75000143], [1.06512499, -3.85258102], [1.12705946, -3.95419121], [1.19059896, -4.05480719], [1.25572634, -4.15440083], [1.32242584, -4.25294971], [1.39068079, -4.35042667], [1.46047401, -4.44681072], [1.53178644, -4.54207277], [1.60460234, -4.63619328], [1.67890167, -4.72914553], [1.75466776, -4.82090807], [1.83187866, -4.91145611], [1.91051626, -5.00076723], [1.99056244, -5.08882093], [2.07199574, -5.17559385], [2.15479422, -5.26106215], [2.23893833, -5.34520626], [2.32440805, -5.42800617], [2.4111805, -5.50943947], [2.49923325, -5.58948421], [2.58854437, -5.66812181], [2.67909384, -5.74533415], [2.77085638, -5.82109976], [2.8638072, -5.89539814], [2.9579277, -5.96821404], [3.05319166, -6.03952789], [3.14957523, -6.10932112], [3.24705076, -6.17757416], [3.34560013, -6.24427414], [3.4451952, -6.30940247], [3.54580784, -6.37294006], [3.64741945, -6.43487549], [3.75000072, -6.49519062], [3.85352612, -6.55387115], [3.95796943, -6.61090136], [4.06330109, -6.66626549], [4.1695013, -6.71995354], [4.2765398, -6.77195024], [4.38438702, -6.82223988], [4.49302101, -6.87081385], [4.6024127, -6.91765738], [4.71253014, -6.96275902], [4.82335281, -7.00610876], [4.93484974, -7.04769516], [5.04699183, -7.08750677], [5.15975189, -7.12553406], [5.27309704, -7.16176653], [5.38700676, -7.19619751], [5.50144815, -7.22881651], [5.61638927, -7.25961494], [5.73180819, -7.28858709], [5.84767199, -7.3157239], [5.96395206, -7.34101868], [6.08061886, -7.36446571], [6.19763899, -7.38605833], [6.314991, -7.40579176], [6.43264103, -7.42366123], [6.55055618, -7.43966103], [6.66871405, -7.45378876], [6.78708124, -7.46603966], [6.90562439, -7.47641087], [7.0243206, -7.4849], [7.1431365, -7.49150515], [7.26204205, -7.49622393], [7.38100815, -7.49905586], [7.5, -7.5]]}]}, {"type": "surfaces", "data": [{"matrix": [[-1.0, 0.0, 30.0], [0.0, -1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[7.5, 7.5], [7.38100815, 7.49905586], [7.26204205, 7.49622393], [7.1431365, 7.49150515], [7.0243206, 7.4849], [6.90562439, 7.47641087], [6.78708124, 7.46603966], [6.66871405, 7.45378876], [6.55055618, 7.43966103], [6.43264103, 7.42366123], [6.314991, 7.40579176], [6.19763899, 7.38605833], [6.08061886, 7.36446571], [5.96395206, 7.34101868], [5.84767199, 7.3157239], [5.73180819, 7.28858709], [5.61638927, 7.25961494], [5.50144815, 7.22881651], [5.38700676, 7.19619751], [5.27309704, 7.16176653], [5.15975189, 7.12553406], [5.04699183, 7.08750677], [4.93484974, 7.04769516], [4.82335281, 7.00610876], [4.71253014, 6.96275902], [4.6024127, 6.91765738], [4.49302101, 6.87081385], [4.38438702, 6.82223988], [4.2765398, 6.77195024], [4.1695013, 6.71995354], [4.06330109, 6.66626549], [3.95796943, 6.61090136], [3.85352612, 6.55387115], [3.75000072, 6.49519062], [3.64741945, 6.43487549], [3.54580784, 6.37294006], [3.4451952, 6.30940247], [3.34560013, 6.24427414], [3.24705076, 6.17757416], [3.14957523, 6.10932112], [3.05319166, 6.03952789], [2.9579277, 5.96821404], [2.8638072, 5.89539814], [2.77085638, 5.82109976], [2.67909384, 5.74533415], [2.58854437, 5.66812181], [2.49923325, 5.58948421], [2.4111805, 5.50943947], [2.32440805, 5.42800617], [2.23893833, 5.34520626], [2.15479422, 5.26106215], [2.07199574, 5.17559385], [1.99056244, 5.08882093], [1.91051626, 5.00076723], [1.83187866, 4.91145611], [1.75466776, 4.82090807], [1.67890167, 4.72914553], [1.60460234, 4.63619328], [1.53178644, 4.54207277], [1.46047401, 4.44681072], [1.39068079, 4.35042667], [1.32242584, 4.25294971], [1.25572634, 4.15440083], [1.19059896, 4.05480719], [1.12705946, 3.95419121], [1.06512499, 3.85258102], [1.00481033, 3.75000143], [0.9461298, 3.64647603], [0.8890996, 3.54203296], [0.83373451, 3.43669939], [0.78004742, 3.33050084], [0.72805119, 3.22346234], [0.6777606, 3.1156137], [0.62918663, 3.00697947], [0.5823431, 2.89758945], [0.53724051, 2.78746867], [0.49389124, 2.67664766], [0.45230532, 2.56515121], [0.41249418, 2.45301056], [0.3744669, 2.34025073], [0.33823347, 2.22690368], [0.30380297, 2.11299586], [0.27118397, 1.99855435], [0.24038458, 1.88360965], [0.21141338, 1.76819265], [0.18427658, 1.6523304], [0.1589818, 1.53605044], [0.13553524, 1.41938567], [0.11394215, 1.30236173], [0.09420872, 1.18501163], [0.07633924, 1.06736159], [0.06033897, 0.94944453], [0.04621172, 0.83128667], [0.03396082, 0.71292132], [0.02358913, 0.59437472], [0.0151, 0.47568026], [0.00849485, 0.3568643], [0.00377607, 0.23796028], [0.00094414, 0.11899456], [0.0, -6.6e-07], [0.00094414, -0.11899456], [0.00377607, -0.23796028], [0.00849485, -0.3568643], [0.0151, -0.47568026], [0.02358913, -0.59437472], [0.03396082, -0.71292132], [0.04621172, -0.83128667], [0.06033897, -0.94944453], [0.07633924, -1.06736159], [0.09420872, -1.18501163], [0.11394215, -1.30236173], [0.13553524, -1.41938567], [0.1589818, -1.53605044], [0.18427658, -1.6523304], [0.21141338, -1.76819265], [0.24038458, -1.88360965], [0.27118397, -1.99855435], [0.30380297, -2.11299586], [0.33823347, -2.22690368], [0.3744669, -2.34025073], [0.41249418, -2.45301056], [0.45230532, -2.56515121], [0.49389124, -2.67664766], [0.53724051, -2.78746867], [0.5823431, -2.89758945], [0.62918663, -3.00697947], [0.6777606, -3.1156137], [0.72805119, -3.22346234], [0.78004742, -3.33050084], [0.83373451, -3.43669939], [0.8890996, -3.54203296], [0.9461298, -3.64647603], [1.00481033, -3.75000143], [1.06512499, -3.85258102], [1.12705946, -3.95419121], [1.19059896, -4.05480719], [1.25572634, -4.15440083], [1.32242584, -4.25294971], [1.39068079, -4.35042667], [1.46047401, -4.44681072], [1.53178644, -4.54207277], [1.60460234, -4.63619328], [1.67890167, -4.72914553], [1.75466776, -4.82090807], [1.83187866, -4.91145611], [1.91051626, -5.00076723], [1.99056244, -5.08882093], [2.07199574, -5.17559385], [2.15479422, -5.26106215], [2.23893833, -5.34520626], [2.32440805, -5.42800617], [2.4111805, -5.50943947], [2.49923325, -5.58948421], [2.58854437, -5.66812181], [2.67909384, -5.74533415], [2.77085638, -5.82109976], [2.8638072, -5.89539814], [2.9579277, -5.96821404], [3.05319166, -6.03952789], [3.14957523, -6.10932112], [3.24705076, -6.17757416], [3.34560013, -6.24427414], [3.4451952, -6.30940247], [3.54580784, -6.37294006], [3.64741945, -6.43487549], [3.75000072, -6.49519062], [3.85352612, -6.55387115], [3.95796943, -6.61090136], [4.06330109, -6.66626549], [4.1695013, -6.71995354], [4.2765398, -6.77195024], [4.38438702, -6.82223988], [4.49302101, -6.87081385], [4.6024127, -6.91765738], [4.71253014, -6.96275902], [4.82335281, -7.00610876], [4.93484974, -7.04769516], [5.04699183, -7.08750677], [5.15975189, -7.12553406], [5.27309704, -7.16176653], [5.38700676, -7.19619751], [5.50144815, -7.22881651], [5.61638927, -7.25961494], [5.73180819, -7.28858709], [5.84767199, -7.3157239], [5.96395206, -7.34101868], [6.08061886, -7.36446571], [6.19763899, -7.38605833], [6.314991, -7.40579176], [6.43264103, -7.42366123], [6.55055618, -7.43966103], [6.66871405, -7.45378876], [6.78708124, -7.46603966], [6.90562439, -7.47641087], [7.0243206, -7.4849], [7.1431365, -7.49150515], [7.26204205, -7.49622393], [7.38100815, -7.49905586], [7.5, -7.5]]}]}, {"type": "rays", "points": [[0.0, 0.0, 15.51687269, -2.73604331], [0.0, 0.0, 15.29690865, -2.08937191], [0.0, 0.0, 15.14611689, -1.47322882], [0.0, 0.0, 15.05140994, -0.8766448], [0.0, 0.0, 15.00564886, -0.29103424], [0.0, 0.0, 15.00564886, 0.29103424], [0.0, 0.0, 15.05140994, 0.8766448], [0.0, 0.0, 15.14611689, 1.47322882], [0.0, 0.0, 15.29690865, 2.08937191], [0.0, 0.0, 15.51687269, 2.73604331]], "color": "#ffa724", "variables": {"base": [-0.17453293, -0.13574783, -0.09696274, -0.05817764, -0.01939255, 0.01939255, 0.05817764, 0.09696274, 0.13574783, 0.17453293]}, "domain": {"base": [-0.17453293, 0.17453293]}, "layers": [1]}, {"type": "rays", "points": [[15.51687269, -2.73604331, 29.81891964, -1.63811333], [15.29690865, -2.08937191, 29.88204215, -1.32493538], [15.14611689, -1.47322882, 29.9368546, -0.9711816], [15.05140994, -0.8766448, 29.97659509, -0.59205218], [15.00564886, -0.29103424, 29.99736327, -0.19885677], [15.00564886, 0.29103424, 29.99736327, 0.19885677], [15.05140994, 0.8766448, 29.97659509, 0.59205218], [15.14611689, 1.47322882, 29.9368546, 0.9711816], [15.29690865, 2.08937191, 29.88204215, 1.32493538], [15.51687269, 2.73604331, 29.81891964, 1.63811333]], "color": "#ffa724", "variables": {"base": [-0.17453293, -0.13574783, -0.09696274, -0.05817764, -0.01939255, 0.01939255, 0.05817764, 0.09696274, 0.13574783, 0.17453293]}, "domain": {"base": [-0.17453293, 0.17453293]}, "layers": [1]}, {"type": "points", "data": [[0.0, 0.0], [15.0, 0.0], [22.5, 0.0], [30.0, 0.0]], "layers": [4]}, {"type": "rays", "points": [[29.81891964, -1.63811333, 48.75419084, 4.8004816], [29.88204215, -1.32493538, 49.30653618, 3.43836509], [29.9368546, -0.9711816, 49.66580159, 2.31038061], [29.97659509, -0.59205218, 49.88391271, 1.33114972], [29.99736327, -0.19885677, 49.98732186, 0.43482742], [29.99736327, 0.19885677, 49.98732186, -0.43482742], [29.97659509, 0.59205218, 49.88391271, -1.33114972], [29.9368546, 0.9711816, 49.66580159, -2.31038061], [29.88204215, 1.32493538, 49.30653618, -3.43836509], [29.81891964, 1.63811333, 48.75419084, -4.8004816]], "color": "#ffa724", "variables": {"base": [-0.17453293, -0.13574783, -0.09696274, -0.05817764, -0.01939255, 0.01939255, 0.05817764, 0.09696274, 0.13574783, 0.17453293]}, "domain": {"base": [-0.17453293, 0.17453293]}, "layers": [3]}]}';

tlmviewer.embed(document.getElementById("tlmviewer-eda4c397"), data);    
</script>



```python
print(optics)
print()
print(optics[2].element[0])

      
# execute_tree = forward_tree(optics, tlm.default_input(2, torch.float64, sampling={"base": 5}))

# execute_tree[2].element[0].context
```

    Sequential(
      (0): PointSource()
      (1): Gap()
      (2): KinematicSurface(
        (element): Sequential(
          (0): CollisionSurface()
          (1): RefractiveBoundary()
        )
      )
      (3): KinematicSurface(
        (element): Sequential(
          (0): CollisionSurface()
          (1): RefractiveBoundary()
        )
      )
    )
    
    CollisionSurface()



```python
from typing import Any, Iterator
from dataclasses import dataclass

from torchlensmaker.full_forward import forward_tree

ins, outs = forward_tree(optics, tlm.default_input(sampling={"base": 5}, dim=2, dtype=torch.float64))
```


```python
outs[optics]
```




    OpticalData(dim=2, dtype=torch.float64, sampling={'base': <torchlensmaker.sampling.samplers.DenseSampler object at 0x7bbe5ad6bbf0>}, transforms=[[IdentityTransform 0x7bbe5ad6adb0 dim=2 dtype=torch.float64], [TranslateTransform 0x7bbe5ae8b770 dim=2 dtype=torch.float64], [TranslateTransform 0x7bbf70508590 dim=2 dtype=torch.float64], [TranslateTransform 0x7bbe5ad90170 dim=2 dtype=torch.float64]], P=tensor([[29.8189, -1.6381],
            [29.9484, -0.8783],
            [30.0000,  0.0000],
            [29.9484,  0.8783],
            [29.8189,  1.6381]], dtype=torch.float64), V=tensor([[ 0.9468,  0.3219],
            [ 0.9892,  0.1466],
            [ 1.0000,  0.0000],
            [ 0.9892, -0.1466],
            [ 0.9468, -0.3219]], dtype=torch.float64), normals=None, rays_base=tensor([-0.1745, -0.0873,  0.0000,  0.0873,  0.1745], dtype=torch.float64), rays_object=None, rays_image=None, rays_wavelength=None, material=<torchlensmaker.materials.NonDispersiveMaterial object at 0x7bbf510d5970>, blocked=tensor([False, False, False, False, False]), loss=tensor(0., dtype=torch.float64))


