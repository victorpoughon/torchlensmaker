# Lens Maker Equation (using Refractive Surface)

Here we create a lens with a fixed spherical shape and compute what its focal length should be, using the formula known as the Lens Maker Equation. Then, we use torchlensmaker forward pass to compute the loss and check that it is close to zero, i.e. that the rays correctly converge to the expected focal point.

Note that it will not be exactly zero because the lens maker equation is an approximation (and a pretty bad one).


```python
import torch
import torch.nn as nn
import torch.optim as optim
import torchlensmaker as tlm

import math
import numpy as np
import matplotlib.pyplot as plt
from itertools import islice

# Lens diameter: 40mm
lens_diameter = 40.0

# Circular surface radius
# Using the cartesian sign convention
R1, R2 = 200, -250

# Indices of refraction
N1, N2 = 1.0, 1.5

# Lens Maker Equation
expected_focal_length = 1 / (
    ((N2 - N1) / N1) * (1/R1 - 1/R2)
)

print("Expected focal length (lens's maker equation):", expected_focal_length)

# Surface shapes of the lens
surface1 = tlm.Sphere(lens_diameter, R1)
surface2 = tlm.Sphere(lens_diameter, R2)

# Setup the optical stack with incident parallel rays
optics = nn.Sequential(
    tlm.PointSourceAtInfinity(lens_diameter,  material=tlm.NonDispersiveMaterial(N1)),
    tlm.Gap(10.),

    tlm.RefractiveSurface(surface1, material=tlm.NonDispersiveMaterial(N2), anchors=("origin", "extent")),
    tlm.Gap(10.),
    tlm.RefractiveSurface(surface2, material=tlm.NonDispersiveMaterial(N1), anchors=("extent", "origin")),
    
    tlm.Gap(expected_focal_length - 5.),  # focal length wrt to center of lens
    tlm.FocalPoint(),
)


# Evaluate model with 20 rays
output = optics(tlm.default_input(dim=2, dtype=torch.float64, sampling={"base": 20}))

loss = output.loss.item()
print("Loss:", loss)

# Render
tlm.show(optics, dim=2, end=250)

```

    Expected focal length (lens's maker equation): 222.2222222222222
    Loss: 0.0534374986049466



<div data-jp-suppress-context-menu id='tlmviewer-e456f3cc' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 10.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[1.0025177, 20.00003624], [0.9823761, 19.79866982], [0.96244812, 19.59728432], [0.94271851, 19.39587975], [0.92320251, 19.19449997], [0.90388489, 18.99305344], [0.88476562, 18.79158974], [0.86585999, 18.59010696], [0.84715271, 18.38865089], [0.8286438, 18.18712807], [0.81034851, 17.98558807], [0.79225159, 17.78402901], [0.77435303, 17.58245277], [0.75666809, 17.38090515], [0.73919678, 17.17929077], [0.72190857, 16.97766113], [0.70481873, 16.77601242], [0.68795776, 16.57439613], [0.67129517, 16.37271309], [0.65483093, 16.17101479], [0.63856506, 15.96930027], [0.62251282, 15.76761627], [0.60665894, 15.56586742], [0.59101868, 15.36410332], [0.57556152, 15.16232491], [0.56033325, 14.96057701], [0.54530334, 14.75876617], [0.5304718, 14.55694103], [0.51583862, 14.35510063], [0.50141907, 14.15324497], [0.48719788, 13.95142365], [0.47319031, 13.74954033], [0.45936584, 13.54764271], [0.44577026, 13.34572983], [0.43237305, 13.14385223], [0.41917419, 12.9419136], [0.40618896, 12.73996067], [0.39338684, 12.53799629], [0.3808136, 12.33606529], [0.36842346, 12.13407516], [0.35626221, 11.93207169], [0.34428406, 11.73005581], [0.33251953, 11.52807713], [0.32095337, 11.32603836], [0.30960083, 11.1239872], [0.29844666, 10.92192554], [0.28749084, 10.71985149], [0.27676392, 10.51781464], [0.26622009, 10.3157196], [0.25588989, 10.11361504], [0.2457428, 9.91149807], [0.23582458, 9.7094202], [0.22610474, 9.50728416], [0.21658325, 9.30513859], [0.20727539, 9.10298347], [0.19816589, 8.90086555], [0.18925476, 8.69869232], [0.18055725, 8.49650955], [0.17207336, 8.2943182], [0.16378784, 8.0921669], [0.15568542, 7.88995838], [0.14781189, 7.68774223], [0.14013672, 7.48551798], [0.13265991, 7.28328657], [0.12539673, 7.08109522], [0.11833191, 6.87884855], [0.11146545, 6.67659473], [0.10482788, 6.47433472], [0.09837341, 6.27211571], [0.09213257, 6.06984234], [0.08609009, 5.86756277], [0.08024597, 5.665277], [0.07463074, 5.46303368], [0.06919861, 5.26073647], [0.0639801, 5.05843401], [0.05895996, 4.85612679], [0.05415344, 4.65386152], [0.04954529, 4.45154476], [0.04515076, 4.24922276], [0.04095459, 4.04689646], [0.03695679, 3.84461403], [0.03315735, 3.64227962], [0.02958679, 3.43994188], [0.02619934, 3.23760033], [0.02302551, 3.03525543], [0.02006531, 2.83295536], [0.01730347, 2.63060451], [0.01473999, 2.42825103], [0.01239014, 2.22589493], [0.01023865, 2.02358437], [0.00830078, 1.82122421], [0.00656128, 1.61886191], [0.00502014, 1.41649818], [0.00367737, 1.21418047], [0.00256348, 1.01181388], [0.00163269, 0.80944633], [0.00091553, 0.6070779], [0.00041199, 0.40475661], [9.155e-05, 0.20238712], [0.0, -1.748e-05], [9.155e-05, -0.20238712], [0.00041199, -0.40475661], [0.00091553, -0.6070779], [0.00163269, -0.80944633], [0.00256348, -1.01181388], [0.00367737, -1.21418047], [0.00502014, -1.41649818], [0.00656128, -1.61886191], [0.00830078, -1.82122421], [0.01023865, -2.02358437], [0.01239014, -2.22589493], [0.01473999, -2.42825103], [0.01730347, -2.63060451], [0.02006531, -2.83295536], [0.02302551, -3.03525543], [0.02619934, -3.23760033], [0.02958679, -3.43994188], [0.03315735, -3.64227962], [0.03695679, -3.84461403], [0.04095459, -4.04689646], [0.04515076, -4.24922276], [0.04954529, -4.45154476], [0.05415344, -4.65386152], [0.05895996, -4.85612679], [0.0639801, -5.05843401], [0.06919861, -5.26073647], [0.07463074, -5.46303368], [0.08024597, -5.665277], [0.08609009, -5.86756277], [0.09213257, -6.06984234], [0.09837341, -6.27211571], [0.10482788, -6.47433472], [0.11146545, -6.67659473], [0.11833191, -6.87884855], [0.12539673, -7.08109522], [0.13265991, -7.28328657], [0.14013672, -7.48551798], [0.14781189, -7.68774223], [0.15568542, -7.88995838], [0.16378784, -8.0921669], [0.17207336, -8.2943182], [0.18055725, -8.49650955], [0.18925476, -8.69869232], [0.19816589, -8.90086555], [0.20727539, -9.10298347], [0.21658325, -9.30513859], [0.22610474, -9.50728416], [0.23582458, -9.7094202], [0.2457428, -9.91149807], [0.25588989, -10.11361504], [0.26622009, -10.3157196], [0.27676392, -10.51781464], [0.28749084, -10.71985149], [0.29844666, -10.92192554], [0.30960083, -11.1239872], [0.32095337, -11.32603836], [0.33251953, -11.52807713], [0.34428406, -11.73005581], [0.35626221, -11.93207169], [0.36842346, -12.13407516], [0.3808136, -12.33606529], [0.39338684, -12.53799629], [0.40618896, -12.73996067], [0.41917419, -12.9419136], [0.43237305, -13.14385223], [0.44577026, -13.34572983], [0.45936584, -13.54764271], [0.47319031, -13.74954033], [0.48719788, -13.95142365], [0.50141907, -14.15324497], [0.51583862, -14.35510063], [0.5304718, -14.55694103], [0.54530334, -14.75876617], [0.56033325, -14.96057701], [0.57556152, -15.16232491], [0.59101868, -15.36410332], [0.60665894, -15.56586742], [0.62251282, -15.76761627], [0.63856506, -15.96930027], [0.65483093, -16.17101479], [0.67129517, -16.37271309], [0.68795776, -16.57439613], [0.70481873, -16.77601242], [0.72190857, -16.97766113], [0.73919678, -17.17929077], [0.75666809, -17.38090515], [0.77435303, -17.58245277], [0.79225159, -17.78402901], [0.81034851, -17.98558807], [0.8286438, -18.18712807], [0.84715271, -18.38865089], [0.86585999, -18.59010696], [0.88476562, -18.79158974], [0.90388489, -18.99305344], [0.92320251, -19.19449997], [0.94271851, -19.39587975], [0.96244812, -19.59728432], [0.9823761, -19.79866982], [1.0025177, -20.00003624]]}]}, {"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 21.80379669], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[-0.80128479, -20.00000191], [-0.78518677, -19.79840469], [-0.76925659, -19.59679794], [-0.753479, -19.39517784], [-0.73786926, -19.19354439], [-0.72242737, -18.99189949], [-0.70715332, -18.79024124], [-0.69203186, -18.58857155], [-0.67707825, -18.3868885], [-0.66227722, -18.18519402], [-0.64764404, -17.98348618], [-0.63317871, -17.7817688], [-0.61889648, -17.58003807], [-0.60475159, -17.37829781], [-0.59077454, -17.17654419], [-0.57696533, -16.97478104], [-0.56330872, -16.77300644], [-0.54981995, -16.57121849], [-0.53648376, -16.36942291], [-0.52333069, -16.16761398], [-0.5103302, -15.96579742], [-0.49749756, -15.76396847], [-0.4848175, -15.56212902], [-0.47232056, -15.36027908], [-0.45999146, -15.15842056], [-0.44779968, -14.95655155], [-0.43579102, -14.754673], [-0.42391968, -14.55278397], [-0.4122467, -14.35088539], [-0.40071106, -14.14897823], [-0.38935852, -13.94706154], [-0.37814331, -13.74513531], [-0.36711121, -13.54320049], [-0.35623169, -13.34125614], [-0.34553528, -13.13930511], [-0.3349762, -12.93734264], [-0.32458496, -12.73537445], [-0.31437683, -12.53339577], [-0.30430603, -12.33140945], [-0.29441833, -12.12941551], [-0.28468323, -11.92741299], [-0.27511597, -11.72540474], [-0.26571655, -11.523386], [-0.25648499, -11.32136059], [-0.24740601, -11.1193285], [-0.23849487, -10.91728783], [-0.22975159, -10.71524143], [-0.22114563, -10.51318741], [-0.21272278, -10.31112766], [-0.20446777, -10.10905933], [-0.19636536, -9.90698528], [-0.18844604, -9.7049036], [-0.18067932, -9.50281715], [-0.17306519, -9.30072403], [-0.1656189, -9.09862518], [-0.15834045, -8.89651966], [-0.15122986, -8.69440842], [-0.14427185, -8.4922905], [-0.13749695, -8.29016876], [-0.13085938, -8.08804131], [-0.12440491, -7.88590765], [-0.11810303, -7.6837697], [-0.11198425, -7.48162651], [-0.10600281, -7.27947855], [-0.10018921, -7.07732582], [-0.09454346, -6.87516737], [-0.08908081, -6.67300606], [-0.08375549, -6.4708395], [-0.07859802, -6.26866913], [-0.0736084, -6.06649399], [-0.06878662, -5.86431503], [-0.06413269, -5.66213274], [-0.05963135, -5.45994663], [-0.05529785, -5.25775623], [-0.0511322, -5.05556345], [-0.04711914, -4.85336637], [-0.04327393, -4.65116692], [-0.03959656, -4.44896412], [-0.03607178, -4.24675846], [-0.0327301, -4.04454994], [-0.02954102, -3.8423388], [-0.02650452, -3.64012527], [-0.02363586, -3.43790913], [-0.02093506, -3.23569083], [-0.0184021, -3.03347039], [-0.01603699, -2.83124781], [-0.01382446, -2.62902379], [-0.01176453, -2.42679763], [-0.0098877, -2.22457004], [-0.00817871, -2.02234101], [-0.00663757, -1.8201108], [-0.00523376, -1.61787927], [-0.00401306, -1.41564667], [-0.00294495, -1.21341312], [-0.00204468, -1.01117885], [-0.00131226, -0.80894387], [-0.00073242, -0.60670835], [-0.00032043, -0.40447247], [-7.629e-05, -0.20223629], [0.0, 0.0], [-7.629e-05, 0.20223629], [-0.00032043, 0.40447247], [-0.00073242, 0.60670835], [-0.00131226, 0.80894387], [-0.00204468, 1.01117885], [-0.00294495, 1.21341312], [-0.00401306, 1.41564667], [-0.00523376, 1.61787927], [-0.00663757, 1.8201108], [-0.00817871, 2.02234101], [-0.0098877, 2.22457004], [-0.01176453, 2.42679763], [-0.01382446, 2.62902379], [-0.01603699, 2.83124781], [-0.0184021, 3.03347039], [-0.02093506, 3.23569083], [-0.02363586, 3.43790913], [-0.02650452, 3.64012527], [-0.02954102, 3.8423388], [-0.0327301, 4.04454994], [-0.03607178, 4.24675846], [-0.03959656, 4.44896412], [-0.04327393, 4.65116692], [-0.04711914, 4.85336637], [-0.0511322, 5.05556345], [-0.05529785, 5.25775623], [-0.05963135, 5.45994663], [-0.06413269, 5.66213274], [-0.06878662, 5.86431503], [-0.0736084, 6.06649399], [-0.07859802, 6.26866913], [-0.08375549, 6.4708395], [-0.08908081, 6.67300606], [-0.09454346, 6.87516737], [-0.10018921, 7.07732582], [-0.10600281, 7.27947855], [-0.11198425, 7.48162651], [-0.11810303, 7.6837697], [-0.12440491, 7.88590765], [-0.13085938, 8.08804131], [-0.13749695, 8.29016876], [-0.14427185, 8.4922905], [-0.15122986, 8.69440842], [-0.15834045, 8.89651966], [-0.1656189, 9.09862518], [-0.17306519, 9.30072403], [-0.18067932, 9.50281715], [-0.18844604, 9.7049036], [-0.19636536, 9.90698528], [-0.20446777, 10.10905933], [-0.21272278, 10.31112766], [-0.22114563, 10.51318741], [-0.22975159, 10.71524143], [-0.23849487, 10.91728783], [-0.24740601, 11.1193285], [-0.25648499, 11.32136059], [-0.26571655, 11.523386], [-0.27511597, 11.72540474], [-0.28468323, 11.92741299], [-0.29441833, 12.12941551], [-0.30430603, 12.33140945], [-0.31437683, 12.53339577], [-0.32458496, 12.73537445], [-0.3349762, 12.93734264], [-0.34553528, 13.13930511], [-0.35623169, 13.34125614], [-0.36711121, 13.54320049], [-0.37814331, 13.74513531], [-0.38935852, 13.94706154], [-0.40071106, 14.14897823], [-0.4122467, 14.35088539], [-0.42391968, 14.55278397], [-0.43579102, 14.754673], [-0.44779968, 14.95655155], [-0.45999146, 15.15842056], [-0.47232056, 15.36027908], [-0.4848175, 15.56212902], [-0.49749756, 15.76396847], [-0.5103302, 15.96579742], [-0.52333069, 16.16761398], [-0.53648376, 16.36942291], [-0.54981995, 16.57121849], [-0.56330872, 16.77300644], [-0.57696533, 16.97478104], [-0.59077454, 17.17654419], [-0.60475159, 17.37829781], [-0.61889648, 17.58003807], [-0.63317871, 17.7817688], [-0.64764404, 17.98348618], [-0.66227722, 18.18519402], [-0.67707825, 18.3868885], [-0.69203186, 18.58857155], [-0.70715332, 18.79024124], [-0.72242737, 18.99189949], [-0.73786926, 19.19354439], [-0.753479, 19.39517784], [-0.76925659, 19.59679794], [-0.78518677, 19.79840469], [-0.80128479, 20.00000191]]}]}, {"type": "points", "data": [[239.02601891, 0.0]], "color": "red"}, {"type": "rays", "points": [[0.0, -20.0, 11.00251258, -20.0], [0.0, -15.55555556, 10.60585593, -15.55555556], [0.0, -11.11111111, 10.30888049, -11.11111111], [0.0, -6.66666667, 10.11114199, -6.66666667], [0.0, -2.22222222, 10.01234606, -2.22222222], [0.0, 2.22222222, 10.01234606, 2.22222222], [0.0, 6.66666667, 10.11114199, 6.66666667], [0.0, 11.11111111, 10.30888049, 11.11111111], [0.0, 15.55555556, 10.60585593, 15.55555556], [0.0, 20.0, 11.00251258, 20.0]], "color": "#ffa724", "variables": {"base": [-20.0, -15.55555556, -11.11111111, -6.66666667, -2.22222222, 2.22222222, 6.66666667, 11.11111111, 15.55555556, 20.0]}, "domain": {"base": [-20.0, 20.0]}, "layers": [1]}, {"type": "rays", "points": [[11.00251258, -20.0, 21.02921406, -19.66446893], [10.60585593, -15.55555556, 21.33660539, -15.27669406], [10.30888049, -11.11111111, 21.56595908, -10.90239602], [10.11114199, -6.66666667, 21.71830053, -6.53764248], [10.01234606, -2.22222222, 21.79430406, -2.17858325], [10.01234606, 2.22222222, 21.79430406, 2.17858325], [10.11114199, 6.66666667, 21.71830053, 6.53764248], [10.30888049, 11.11111111, 21.56595908, 10.90239602], [10.60585593, 15.55555556, 21.33660539, 15.27669406], [11.00251258, 20.0, 21.02921406, 19.66446893]], "color": "#ffa724", "variables": {"base": [-20.0, -15.55555556, -11.11111111, -6.66666667, -2.22222222, 2.22222222, 6.66666667, 11.11111111, 15.55555556, 20.0]}, "domain": {"base": [-20.0, 20.0]}, "layers": [1]}, {"type": "rays", "points": [[21.02921406, -19.66446893, 239.02540148, 0.00684352], [21.33660539, -15.27669406, 239.03073086, -0.06729306], [21.56595908, -10.90239602, 239.03034275, -0.08658834], [21.71830053, -6.53764248, 239.02803185, -0.06725524], [21.79430406, -2.17858325, 239.02626778, -0.02495826], [21.79430406, 2.17858325, 239.02626778, 0.02495826], [21.71830053, 6.53764248, 239.02803185, 0.06725524], [21.56595908, 10.90239602, 239.03034275, 0.08658834], [21.33660539, 15.27669406, 239.03073086, 0.06729306], [21.02921406, 19.66446893, 239.02540148, -0.00684352]], "color": "#ffa724", "variables": {"base": [-20.0, -15.55555556, -11.11111111, -6.66666667, -2.22222222, 2.22222222, 6.66666667, 11.11111111, 15.55555556, 20.0]}, "domain": {"base": [-20.0, 20.0]}}, {"type": "points", "data": [[0.0, 0.0], [10.0, 0.0], [11.00251258, 0.0], [21.00251258, 0.0], [21.80379669, 0.0], [239.02601891, 0.0]], "layers": [4]}, {"type": "rays", "points": [[21.02921406, -19.66446893, 270.01754961, 2.80348064], [21.33660539, -15.27669406, 270.72867419, 2.14731301], [21.56595908, -10.90239602, 271.2573229, 1.51625261], [21.71830053, -6.53764248, 271.60755568, 0.90279858], [21.79430406, -2.17858325, 271.78201919, 0.29978035], [21.79430406, 2.17858325, 271.78201919, -0.29978035], [21.71830053, 6.53764248, 271.60755568, -0.90279858], [21.56595908, 10.90239602, 271.2573229, -1.51625261], [21.33660539, 15.27669406, 270.72867419, -2.14731301], [21.02921406, 19.66446893, 270.01754961, -2.80348064]], "color": "#ffa724", "variables": {"base": [-20.0, -15.55555556, -11.11111111, -6.66666667, -2.22222222, 2.22222222, 6.66666667, 11.11111111, 15.55555556, 20.0]}, "domain": {"base": [-20.0, 20.0]}, "layers": [3]}]}';

tlmviewer.embed(document.getElementById("tlmviewer-e456f3cc"), data);    
</script>


# Next

* optimize the gap with VariableGap to improve the best fit focal distance estimation
* resample the shape to a parabola to reduce spherical aberation
