# Test local collide


```python
import torchlensmaker as tlm
import torch
import torch.nn as nn
from pprint import pprint

from torchlensmaker.testing.basic_transform import basic_transform
from torchlensmaker.core.transforms import IdentityTransform
from torchlensmaker.testing.collision_datasets import (
    NormalRays,
    TangentRays,
    RandomRays,
    FixedRays,
    make_offset_rays,
)

from torchlensmaker.core.collision_detection import CollisionMethod, Newton, LM

from torchlensmaker.core.surfaces import CircularPlane, Sphere, SphereR

from torchlensmaker.core.geometry import rotated_unit_vector, unit3d_rot, unit2d_rot

import matplotlib.pyplot as plt

import sys
import traceback

from torchlensmaker.testing.dataset_view import dataset_view, convergence_plot
from torchlensmaker.testing.check_local_collide import check_local_collide


test_cases = [
    # Failing cases so far with LM
    (tlm.Sphere(30, 30), TangentRays(dim=2, N=15, distance=-0.6, epsilon=0.05), True),
    (tlm.Sphere(30, 30), FixedRays(dim=2, N=15, direction=unit2d_rot(45), offset=30, epsilon=0.05), True),
    (tlm.Sphere(30, 30), FixedRays(dim=2, N=15, direction=unit2d_rot(65), offset=30, epsilon=0.05), True),
    (tlm.Sphere(30, 30), FixedRays(dim=2, N=15, direction=unit2d_rot(85), offset=30, epsilon=0.05), True),

    # Failing with Newton init_best_axis, because of nan in dot product
    #(tlm.Sphere(30, 30), FixedRays(direction=torch.tensor([0., 1.0]), offset=30, N=15), True),
]

test_cases = [
    # Fails weirdly with float32, not 64!
    (tlm.SphereR(5, 10, dtype=torch.float32), NormalRays(dim=2, N=5, offset=10.0, epsilon=0.1), True),
    (tlm.SphereR(5, 10, dtype=torch.float64), NormalRays(dim=2, N=5, offset=10.0, epsilon=0.1), True)
]

test_cases = [
    (tlm.Asphere(10, 50, 1.0, 0.005, dtype=torch.float64),
    FixedRays(dim=2, N=15, direction=torch.tensor([0.1736, 0.9848], dtype=torch.float64), offset=0.0, epsilon=0.01),
    True)
]

show_all = True

offset_space = torch.cat(
        (
            torch.logspace(-6, 3, 20),
            torch.linspace(0.0, 100.0, 20),
            #-torch.logspace(-6, 2, 20),
            #-torch.linspace(0.0, 100.0, 20),
        ),
        dim=0,
    )


for surface, gen, expected_collide in test_cases:
    genP, genV = gen(surface)

    #P, V = make_offset_rays(genP, genV, offset_space)
    P, V = genP + 68.4211*genV, genV

    print(P.shape)

    if show_all:
        dataset_view(surface, P, V, rays_length=1000)

    # check collisions
    try:
        check_local_collide(surface, P, V, expected_collide)
    except AssertionError as err:
        _, _, tb = sys.exc_info()
        traceback.print_tb(tb)

        # tlmviewer view
        print("Test failed")
        print(gen)
        print("expected_collide:", expected_collide)
        print("AssertionError:", err)
        dataset_view(surface, P, V)

        if isinstance(surface, tlm.ImplicitSurface):
            convergence_plot(surface, P, V, dataset_name=str(gen.__class__.__name__), methods=[surface.collision_method])


```

    torch.Size([15, 2])



<div data-jp-suppress-context-menu id='tlmviewer-acd8a916' class='tlmviewer' style='width: 100%; aspect-ratio: 16 / 9;'></div><script type='module'>async function importtlm() {
    try {
        return await import("/tlmviewer.js");
    } catch (error) {
        console.log("error", error);
        return await import("/files/test_notebooks/tlmviewer.js");
    }
}

const module = await importtlm();
const tlmviewer = module.tlmviewer;

const data = '{"mode": "2D", "camera": "XY", "data": [{"type": "points", "data": [[15.126193201959698, 62.4321774034635], [13.679094849184088, 63.13932026060636], [12.78482934961643, 63.84646311774922], [12.278294921223926, 64.55360597489208], [12.024408848517439, 65.26074883203493], [11.918107141706928, 65.96789168917779], [11.884344276529836, 66.67503454632065], [11.878093011008596, 67.3821774034635], [11.884344276529836, 68.08932026060636], [11.918107141706928, 68.79646311774921], [12.024408848517439, 69.50360597489207], [12.278294921223926, 70.21074883203492], [12.78482934961643, 70.9178916891778], [13.679094849184088, 71.62503454632065], [15.126193201959698, 72.3321774034635]], "color": "grey"}, {"type": "points", "data": [[3.248100190951101, -4.950000000000003], [1.8010018381755017, -4.242857142857083], [2.3302354892930452, 4.53952744006218], [1.6269904384901412, 4.130768102793972], [1.1906281345775902, 3.8027577773807764], [0.913919107270722, 3.543212102122638], [0.7156485477608836, 3.3171338914147483], [0.5421647078396177, 3.0755979509242763], [0.3691214168256156, 2.7656366647727424], [0.20103865576305857, 2.327747420989283], [0.14631583750885113, 2.121428571428609], [0.40020191021533336, 2.8285714285714363], [0.9067363386078338, 3.535714285714292], [1.801001838175491, 4.242857142857147], [3.248100190951101, 4.950000000000003]], "color": "#ff0000"}, {"type": "arrows", "data": [[-0.3681219556685047, -0.9297775141154981, 3.248100190951101, -4.950000000000003, 1.0], [-0.526902842004363, -0.8499255232593768, 1.8010018381755017, -4.242857142857083, 1.0], [-0.4540113012716556, 0.8909959249725096, 2.3302354892930452, 4.53952744006218, 1.0], [-0.5565299437267216, 0.8308275523449689, 1.6269904384901412, 4.130768102793972, 1.0], [-0.6476933484824117, 0.7619011263488467, 1.1906281345775902, 3.8027577773807764, 1.0], [-0.721071158809092, 0.69286101343178, 0.913919107270722, 3.543212102122638, 1.0], [-0.782152889188415, 0.6230865573371126, 0.7156485477608836, 3.3171338914147483, 1.0], [-0.8408918142425069, 0.5412032490108915, 0.5421647078396177, 3.0755979509242763, 1.0], [-0.902030646280305, 0.43167199720521043, 0.3691214168256156, 2.7656366647727424, 1.0], [-0.9581132697825486, 0.28638952890528835, 0.20103865576305857, 2.327747420989283, 1.0], [-0.9738153707590812, 0.2273403256647471, 0.14631583750885113, 2.121428571428609, 1.0], [-0.8910622024851931, 0.4538812083598929, 0.40020191021533336, 2.8285714285714363, 1.0], [-0.7231590710406766, 0.6906815170334195, 0.9067363386078338, 3.535714285714292, 1.0], [-0.5269028420043463, 0.849925523259387, 1.801001838175491, 4.242857142857147, 1.0], [-0.3681219556685047, 0.9297775141154981, 3.248100190951101, 4.950000000000003, 1.0]]}, {"type": "rays", "points": [[-158.4765844647045, -922.3835797747098, 188.7289708686239, 1047.2479345816369], [-159.9236828174801, -921.6764369175669, 187.28187251584828, 1047.9550774387797], [-160.81794831704775, -920.9692940604241, 186.38760701628064, 1048.6622202959225], [-161.32448274544026, -920.2621512032812, 185.88107258788813, 1049.3693631530653], [-161.57836881814677, -919.5550083461384, 185.62718651518162, 1050.0765060102083], [-161.68467052495726, -918.8478654889955, 185.52088480837114, 1050.783648867351], [-161.71843339013435, -918.1407226318527, 185.48712194319404, 1051.4907917244939], [-161.7246846556556, -917.4335797747098, 185.48087067767278, 1052.1979345816367], [-161.71843339013435, -916.726436917567, 185.48712194319404, 1052.9050774387797], [-161.68467052495726, -916.019294060424, 185.52088480837114, 1053.6122202959225], [-161.57836881814677, -915.3121512032812, 185.62718651518162, 1054.3193631530653], [-161.32448274544026, -914.6050083461383, 185.88107258788813, 1055.026506010208], [-160.81794831704775, -913.8978654889954, 186.38760701628064, 1055.7336488673511], [-159.9236828174801, -913.1907226318526, 187.28187251584828, 1056.440791724494], [-158.4765844647045, -912.4835797747098, 188.7289708686239, 1057.1479345816367]], "color": "#ffa724", "variables": {}, "domain": {}, "layers": [0]}, {"type": "surfaces", "data": [{"matrix": [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "samples": [[3.3762626584708366, -5.0], [3.1211887113117043, -4.898989898989899], [2.8810183285064372, -4.797979797979798], [2.6551516308163534, -4.696969696969697], [2.443001236972817, -4.595959595959596], [2.2439922636452816, -4.494949494949495], [2.0575623254101503, -4.393939393939394], [1.883161534720443, -4.292929292929293], [1.7202525018762589, -4.191919191919192], [1.5683103349960492, -4.090909090909091], [1.4268226399886508, -3.98989898989899], [1.2952895205261072, -3.888888888888889], [1.1732235780172506, -3.787878787878788], [1.0601499115820399, -3.686868686868687], [0.9556061180266565, -3.585858585858586], [0.8591422918193317, -3.484848484848485], [0.7703210250669186, -3.383838383838384], [0.6887174074921852, -3.282828282828283], [0.6139190264118359, -3.1818181818181817], [0.5455259667152402, -3.080808080808081], [0.48315081084387523, -2.9797979797979797], [0.42641863877146946, -2.878787878787879], [0.3749670279848404, -2.7777777777777777], [0.3284460534654278, -2.676767676767677], [0.2865182876715074, -2.5757575757575757], [0.24885880052108822, -2.474747474747475], [0.2151551593754825, -2.3737373737373737], [0.1851074290235485, -2.272727272727273], [0.15842817166659603, -2.1717171717171717], [0.13484244690395655, -2.070707070707071], [0.11408781171920697, -1.9696969696969697], [0.09591432046704927, -1.8686868686868687], [0.08008452486083759, -1.7676767676767677], [0.06637347396075195, -1.6666666666666667], [0.05456871416261366, -1.5656565656565657], [0.044470289187339876, -1.4646464646464648], [0.035890740071034086, -1.3636363636363638], [0.028655105155709605, -1.2626262626262628], [0.02260092008064346, -1.1616161616161618], [0.01757821777435826, -1.0606060606060608], [0.013449528447229535, -0.9595959595959597], [0.010089879584716637, -0.8585858585858587], [0.007386795941215147, -0.7575757575757577], [0.00524029953452902, -0.6565656565656567], [0.0035629096409609522, -0.5555555555555556], [0.0022796427910194983, -0.45454545454545464], [0.0013280127657417254, -0.3535353535353536], [0.0006580305936303909, -0.2525252525252526], [0.00023220454820471084, -0.1515151515151516], [2.554014616406e-05, -0.050505050505050594], [2.554014616406e-05, 0.050505050505050594], [0.00023220454820471084, 0.1515151515151516], [0.0006580305936303909, 0.2525252525252526], [0.0013280127657417254, 0.3535353535353536], [0.0022796427910194983, 0.45454545454545464], [0.0035629096409609522, 0.5555555555555556], [0.00524029953452902, 0.6565656565656567], [0.007386795941215147, 0.7575757575757577], [0.010089879584716637, 0.8585858585858587], [0.013449528447229535, 0.9595959595959597], [0.01757821777435826, 1.0606060606060608], [0.02260092008064346, 1.1616161616161618], [0.028655105155709605, 1.2626262626262628], [0.035890740071034086, 1.3636363636363638], [0.044470289187339876, 1.4646464646464648], [0.05456871416261366, 1.5656565656565657], [0.06637347396075195, 1.6666666666666667], [0.08008452486083759, 1.7676767676767677], [0.09591432046704927, 1.8686868686868687], [0.11408781171920697, 1.9696969696969697], [0.13484244690395655, 2.070707070707071], [0.15842817166659603, 2.1717171717171717], [0.1851074290235485, 2.272727272727273], [0.2151551593754825, 2.3737373737373737], [0.24885880052108822, 2.474747474747475], [0.2865182876715074, 2.5757575757575757], [0.3284460534654278, 2.676767676767677], [0.3749670279848404, 2.7777777777777777], [0.42641863877146946, 2.878787878787879], [0.48315081084387523, 2.9797979797979797], [0.5455259667152402, 3.080808080808081], [0.6139190264118359, 3.1818181818181817], [0.6887174074921852, 3.282828282828283], [0.7703210250669186, 3.383838383838384], [0.8591422918193317, 3.484848484848485], [0.9556061180266565, 3.585858585858586], [1.0601499115820399, 3.686868686868687], [1.1732235780172506, 3.787878787878788], [1.2952895205261072, 3.888888888888889], [1.4268226399886508, 3.98989898989899], [1.5683103349960492, 4.090909090909091], [1.7202525018762589, 4.191919191919192], [1.883161534720443, 4.292929292929293], [2.0575623254101503, 4.393939393939394], [2.2439922636452816, 4.494949494949495], [2.443001236972817, 4.595959595959596], [2.6551516308163534, 4.696969696969697], [2.8810183285064372, 4.797979797979798], [3.1211887113117043, 4.898989898989899], [3.3762626584708366, 5.0]]}]}]}';

setTimeout(() => {
    tlmviewer.embed(document.getElementById("tlmviewer-acd8a916"), data);    
}, 0);
</script>

